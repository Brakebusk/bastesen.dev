/*! terminal.js - hermaba@uio.no */
function loadDirectories(e){var t=new XMLHttpRequest;t.onreadystatechange=function(){4==this.readyState&&200==this.status&&(dirStruct=JSON.parse(this.responseText),addOutput(navigate("/etc",!1).files.motd.content,"10px"))},t.open("GET",e,!0),t.send()}function onloadPrep(){loadDirectories("directory.min.json"),document.getElementById("commandInput").addEventListener("keydown",function(e){(38===e.keyCode||40===e.keyCode||9===e.keyCode||76===e.keyCode&&e.ctrlKey)&&e.preventDefault()}),focusInput()}function focusInput(){window.getSelection().toString()||document.getElementById("commandInput").focus()}function inputKeydown(e){switch(e.keyCode){case 13:enterCommand();break;case 38:prevCommand();break;case 40:nextCommand();break;case 9:autofill();break;case 76:e.ctrlKey&&handle_clear();break;case 67:e.ctrlKey&&cancelCommand()}}function enterCommand(){cIndex=-1,tmpCmd="";let e=document.getElementById("commandInput"),t=e.value;e.value="",awaitInput?callBack(t):(addToLog(t),t.length>0&&commandHistory.push(t),parseCommand(t),awaitInput||updatePathLabels());let n=document.getElementById("terminal");n.scrollTop=n.scrollHeight}function cancelCommand(){document.getElementById("commandInput").type="text",awaitInput=!1,callBack=null,updatePathLabels();let e=document.getElementById("terminal");e.scrollTop=e.scrollHeight}function createAwaitInput(e,t,n){awaitInput=!0,callBack=t,document.getElementById("commandPath").textContent=e+": ",n&&(document.getElementById("commandInput").type="password")}function prevCommand(){var e=document.getElementById("commandInput");commandHistory.length>0&&(cIndex>0?cIndex--:-1==cIndex&&(cIndex=commandHistory.length-1,tmpCmd=e.value),e.value=commandHistory[cIndex])}function nextCommand(){var e=document.getElementById("commandInput");-1!=cIndex&&(cIndex++,cIndex==commandHistory.length?(cIndex=-1,e.value=tmpCmd):e.value=commandHistory[cIndex])}function autofill(){function e(e){return e.startsWith(i)}let t=document.getElementById("commandInput"),n=t.value.split(" ");n=n[n.length-1];let r=n.split("/");var i=r[r.length-1];let a=n.substr(0,n.length-i.length-1);try{var d=navigate(a,!1)}catch(e){console.log("Error: unable to navigate to current directory.")}let o=d.directories,l=d.files;o=sortedKeys(o,!1),l=sortedKeys(l,!1);let s=o.concat(l);s.sort();let c=s.find(e);c&&(t.value+=c.slice(i.length))}function parseCommand(e){if(e.length>0)if(e.startsWith("./"))runScript(e);else switch(e.split(" ")[0]){case"ls":handle_ls(e);break;case"mkdir":handle_mkdir(e);break;case"cat":handle_cat(e);break;case"cd":handle_cd(e);break;case"pwd":handle_pwd(e);break;case"touch":handle_touch(e);break;case"head":handle_head(e);break;case"tail":handle_tail(e);break;case"rm":handle_rm(e);break;case"rmdir":handle_rmdir(e);break;case"history":handle_history(e);break;case"cp":handle_cp(e);break;case"mv":handle_mv(e);break;case"find":handle_find(e);break;case"grep":handle_grep(e);break;case"clear":handle_clear(e);break;case"help":handle_help(e);break;case"sudo":handle_sudo(e);break;default:addOutput("-bash: "+e+": command not found")}}function addOutput(e,t){let n=document.createElement("div");n.className="commandOutput",null!=t&&(n.style.fontSize=t),n.textContent=e,document.getElementById("terminalOutput").appendChild(n)}function addToLog(e){let t=document.createElement("div");t.className="command";let n=path;"/home/guest"==path.slice(0,11)&&(n="~"+path.slice(11)),t.textContent="guest@h4ck32m4n:"+n+"$ "+e,document.getElementById("terminalOutput").appendChild(t)}function updatePathLabels(){"/home/guest"==path?document.getElementById("titlePath").textContent="guest":"/home/guest"==path.slice(0,11)?document.getElementById("titlePath").textContent="~"+path.slice(11):document.getElementById("titlePath").textContent=path;let e=path;"/home/guest"==path.slice(0,11)&&(e="~"+path.slice(11)),document.getElementById("commandPath").textContent="guest@h4ck32m4n:"+e+"$ "}function navigate(e,t){let n=path;e.length>0&&("/"==e[0]?n=e:n+="/"+e);let r=n.split("/"),i=[],a=dirStruct["/"],d=[];for(var o=1;o<r.length;o++)if(""!=r[o])switch(r[o]){case".":break;case"..":a=i.pop(),d.pop();break;default:if(i.push(a),d.push(r[o]),a=a.directories[r[o]],!a)throw"Invalid path"}return t?"/"+d.join("/"):a}function sortedKeys(e,t){var n=[];for(var r in e)n.push(r);return n.sort(),t&&n.reverse(),n}function getArgs(e){return e.match(/[^\s"']+|"([^"]*)"|'([^']*)'/gm)}function runScript(command){("/home/hackerman"==path&&"./decryptor"==command||"./decryptor.sh"==command)&&(script=atob(navigate("",!1).files["decryptor.sh"].content),eval(script))}function handle_ls(e){e=e.slice(3);let t=e.split(" "),n="",r=!1,i=!1,a=!1,d=!1;for(var o=0;o<t.length;o++)if("-"==t[o][0])switch(t[o]){case"-l":r=!0;break;case"-a":i=!0;break;case"-la":r=!0,i=!0;break;case"-F":a=!0;break;case"-r":d=!0;break;default:return void addOutput("ls: invalid option -- '"+t[o].slice(1)+"'")}else n=t[o];try{var l=navigate(n,!1)}catch(e){return void addOutput("ls: cannot access '"+n+"': No such file or directory")}let s="",c=l.directories,u=l.files;if(i&&(c["."]={edited:l.edited},c[".."]={edited:l.edited}),c=sortedKeys(c,d),u=sortedKeys(u,d),r){var h=0;for(o=0;o<u.length;o++){let e=l.files[u[o]].content.length;e.toString().length>h&&(h=e.toString().length)}for(o=0;o<c.length;o++){s.length>0&&(s+="\r\n");let e=l.directories[c[o]].edited,t=h-3;t<0&&(h=3,t=0),s+="drwxrwxrwxr 1 guest guest "+" ".repeat(t)+"512 "+e+" "+c[o]}for(o=0;o<u.length;o++){s.length>0&&(s+="\r\n");let e=l.files[u[o]].content.length,t=l.files[u[o]].edited,n=h-e.toString().length;n<0&&(n=0),s+="-rwxrwxrwxr 1 guest guest "+" ".repeat(n)+e+" "+t+" "+u[o]}}else{for(var o=0;o<c.length;o++)s+=c[o],a&&(s+="/"),s+=" ";for(var o=0;o<u.length;o++)s+=u[o]+" "}addOutput(s),i&&(delete l.directories[".."],delete l.directories["."])}function handle_mkdir(e){for(var t=e.slice(6),n=t.split(" "),r=0;r<n.length;r++){let e=n[r].split("/"),t=e[e.length-1];if(""==t)return void addOutput("mkdir: missing operand");var i=n[r].substr(0,n[r].length-t.length-1);try{var a=navigate(i,!1)}catch(e){return void addOutput("mkdir: cannot create directory '"+i+"': No such file or directory")}let d=!1;if((t in a.files||t in a.directories)&&(d=!0),d)return void addOutput("mkdir: cannot create directory '"+t+"': File exists");{let e=new Date,n=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],r=e.getDate().toString();1==r.length&&(r+=" "),a.directories[t]={edited:n[e.getMonth()]+" "+r+" "+e.getHours().toString()+":"+e.getMinutes().toString(),files:{},directories:{}}}}}function handle_cat(e){var t=e.slice(4);let n=t.split("/");var r=n[n.length-1],i=t.substr(0,t.length-r.length-1);try{var a=navigate(i,!1);if(!(r in a.files))throw"File does not exists";addOutput(a.files[r].content)}catch(e){return void addOutput("cat: "+t+": No such file or directory")}}function handle_cd(e){var t=e.slice(3);try{path=navigate(t,!0)}catch(e){return void addOutput("-bash: cd: "+t+": No such directory")}updatePathLabels()}function handle_pwd(e){addOutput(path)}function handle_touch(e){for(var t=e.slice(6),n=t.split(" "),r=0;r<n.length;r++){let e=n[r].split("/"),t=e[e.length-1];if(""==t)return void addOutput("touch: missing file operand");var i=n[r].substr(0,n[r].length-t.length-1);try{var a=navigate(i,!1)}catch(e){return void addOutput("touch: cannot touch '"+i+"': No such file or directory")}let o=new Date,l=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],s=o.getDate().toString();1==s.length&&(s+=" ");var d=l[o.getMonth()]+" "+s+" "+o.getHours().toString()+":"+o.getMinutes().toString();t in a.files?a.files[t].edited=d:t in a.directories?a.directories[t].edited=d:a.files[t]={content:"",edited:d}}}function handle_head(e){e=e.slice(5);var t=10,n="";let r=e.split(" ");for(var i=0;i<r.length;i++)if("-"==r[i][0])switch(r[i]){case"-n":if(i+1==r.length)return void addOutput("head: option requires an argument -- 'n'");if(t=parseInt(r[++i]),isNaN(t))return void addOutput("head: invalid number of lines: '"+r[i]+"'");break;default:return void addOutput("head: invalid option -- '"+r[i].slice(1)+"'")}else n=r[i];let a=n.split("/");var d=a[a.length-1],o=n.substr(0,n.length-d.length-1);try{var l=navigate(o,!1);if(!(d in l.files))throw"File does not exists";var s=l.files[d].content.split("\n"),c="";for(i=0;i<s.length&&i<t;i++)c+=s[i]+"\r\n";addOutput(c)}catch(e){return void addOutput("head: cannot open '"+n+"' for reading: No such file or directory")}}function handle_tail(e){e=e.slice(5);var t=10,n="";let r=e.split(" ");for(var i=0;i<r.length;i++)if("-"==r[i][0])switch(r[i]){case"-n":if(i+1==r.length)return void addOutput("tail: option requires an argument -- 'n'");if(t=parseInt(r[++i]),isNaN(t))return void addOutput("tail: invalid number of lines: '"+r[i]+"'");break;default:return void addOutput("tail: invalid option -- '"+r[i].slice(1)+"'")}else n=r[i];let a=n.split("/");var d=a[a.length-1],o=n.substr(0,n.length-d.length-1);try{var l=navigate(o,!1);if(!(d in l.files))throw"File does not exists";var s=l.files[d].content.split("\n"),c="";start=s.length-t-1,start<0&&(start=0);for(i=start;i<s.length;i++)c+=s[i]+"\r\n";addOutput(c)}catch(e){return void addOutput("tail: cannot open '"+n+"' for reading: No such file or directory")}}function handle_rm(e){e=e.slice(3);const t=getArgs(e);for(var n=!1,r=!1,i=0;i<t.length;i++)if("-"==t[i][0])switch(t[i]){case"-r":n=!0;break;case"-v":case"-f":r=!0;break;default:return void addOutput("cp: invalid option -- '"+t[i].slice(1)+"'")}else{var a=t[i],d=a.split("/"),o=d[d.length-1],l=a.substr(0,a.length-o.length-1);try{var s=navigate(l);if(o in s.files)delete s.files[o],r&&addOutput("removed '"+a+"'");else{if(!(o in s.directories)){addOutput("rm: failed to remove '"+a+"': No such file or directory");continue}if(!n){addOutput("rm: cannot remove '"+a+"': Is a directory");continue}{function c(e){const t=sortedKeys(e.files,!1),n=sortedKeys(e.directories,!1);for(var r=0;r<t.length;r++)addOutput("removed '"+t[r]+"'");for(r=0;r<n.length;r++)c(e.directories[n[r]]),addOutput("removed directory '"+n[r]+"'")}c(s.directories[o]),addOutput("removed directory '"+a+"'"),delete s.directories[o]}}}catch(e){addOutput("rm: failed to remove '"+a+"': No such file or directory");continue}}}function handle_rmdir(e){e=e.slice(6);const t=getArgs(e);for(var n=0;n<t.length;n++){var r=t[n],i=r.split("/"),a=i[i.length-1],d=r.substr(0,r.length-a.length-1);try{var o=navigate(d);if(!(a in o.directories)){if(a in o.files){addOutput("rmdir: failed to remove '"+r+"': Not a directory");continue}addOutput("rmdir: failed to remove '"+r+"': No such file or directory");continue}delete o.directories[a]}catch(e){addOutput("rmdir: failed to remove '"+r+"': No such file or directory");continue}}}function handle_history(e){let t="";for(var n=0;n<commandHistory.length;n++)t+=" "+(n+1)+" "+commandHistory[n],n<commandHistory.length-1&&(t+="\r\n");addOutput(t)}function handle_cp(e){e=e.slice(3);const t=getArgs(e);for(var n=!1,r=!1,i=null,a=null,d=0;d<t.length;d++){if("-"!=t[d][0]){i=t[d],d==t.length-1&&addOutput("cp: missing destination file operand after '"+i+"'"),a=t[d+1];break}switch(t[d]){case"-r":case"-R":n=!0;break;case"-f":!0;break;case"-v":r=!0;break;default:return void addOutput("cp: invalid option -- '"+t[d].slice(1)+"'")}}try{const e=i.split("/"),t=e[e.length-1],u=i.substr(0,i.length-t.length-1),h=a.split("/"),p=h[h.length-1],f=a.substr(0,a.length-p.length-1);var o=navigate(u,!1);if(t in o.files)try{var l=navigate(f),s=sortedKeys(o.files[t],!1);l.files[p]={};for(d=0;d<s.length;d++)l.files[p][s[d]]=o.files[t][s[d]];r&&addOutput("'"+i+"' -> '"+a+"'")}catch(e){return void addOutput("cp: cannot create regular file '"+a+"': No such file or directory")}else{if(!(t in o.directories&&n)){if(t in o.directories&&!n)return void addOutput("cp: -r not specified; omitting directory '"+i+"'");throw"File does not exists"}try{l=navigate(f),s=sortedKeys(o.files[t],!1);if(l.directories[p]={...o.directories[t]},r){function c(e,t){const n=sortedKeys(e.files,!1),r=sortedKeys(e.directories,!1),i=sortedKeys(t.files,!1),a=sortedKeys(t.directories,!1);for(var d=0;d<n.length;d++)addOutput("'"+n[d]+"' -> '"+i[d]+"'");for(d=0;d<r.length;d++)addOutput("'"+r[d]+"' -> '"+r[d]+"'"),c(e.directories[r[d]],t.directories[a[d]])}addOutput("'"+i+"' -> '"+a+"'"),c(o.directories[t],l.directories[p])}}catch(e){return void addOutput("cp: cannot create directory '"+a+"': No such file or directory")}}}catch(e){return void addOutput("cp: cannot stat: '"+i+"': No such file or directory")}}function handle_mv(e){e=e.slice(3);const t=getArgs(e);for(var n=!1,r=null,i=null,a=0;a<t.length;a++){if("-"!=t[a][0]){r=t[a],a==t.length-1&&addOutput("mv: missing destination file operand after '"+r+"'"),i=t[a+1];break}switch(t[a]){case"-f":!0;break;case"-v":n=!0;break;default:addOutput("mv: invalid option -- '"+t[a].slice(1)+"'")}}try{const e=r.split("/"),t=e[e.length-1],c=r.substr(0,r.length-t.length-1),u=i.split("/"),h=u[u.length-1],p=i.substr(0,i.length-h.length-1);var d=navigate(c,!1);if(t in d.files)try{var o=navigate(p),l=sortedKeys(d.files[t],!1);o.files[h]={};for(a=0;a<l.length;a++)o.files[h][l[a]]=d.files[t][l[a]];delete d.files[t],n&&addOutput("'"+r+"' -> '"+i+"'")}catch(e){return void addOutput("mv: cannot create regular file '"+i+"': No such file or directory")}else{if(!(t in d.directories))throw"File does not exists";try{o=navigate(p),l=sortedKeys(d.files[t],!1);if(o.directories[h]={...d.directories[t]},n){function s(e,t){sFiles=sortedKeys(e.files,!1),sDirs=sortedKeys(e.directories,!1),dFiles=sortedKeys(t.files,!1),dDirs=sortedKeys(t.directories,!1);for(var n=0;n<sFiles.length;n++)addOutput("'"+sFiles[n]+"' -> '"+dFiles[n]+"'");for(n=0;n<sDirs.length;n++)addOutput("'"+sDirs[n]+"' -> '"+sDirs[n]+"'"),s(e.directories[sDirs[n]],t.directories[dDirs[n]])}addOutput("'"+r+"' -> '"+i+"'"),s(d.directories[t],o.directories[h])}delete d.directories[t]}catch(e){return void addOutput("mv: cannot create directory '"+i+"': No such file or directory")}}}catch(e){return void addOutput("mv: cannot stat: '"+r+"': No such file or directory")}}function handle_find(e){addOutput("Not implemented..")}function handle_grep(e){e=e.slice(5);const t=getArgs(e),n=t[t.length-1];try{RegExp(t[0])}catch(e){return void addOutput("grep: bad regular expression '"+t[0]+"'")}let r=n.split("/");var i=r[r.length-1],a=n.substr(0,n.length-i.length-1);try{var d=navigate(a,!1);if(!(i in d.files))throw"File does not exists";{const e=d.files[i].content.split("\n");for(var o=0;o<e.length;o++)pattern.test(e[o])&&addOutput(e[o])}}catch(e){return void addOutput("grep: "+n+": No such file or directory")}}function handle_clear(e){document.getElementById("terminalOutput").innerHTML=""}function handle_sudo(e){parseCommand(e.substr(5))}function handle_help(e){let t="";t+="cat <filename> \r\n",t+="cd <path> \r\n",t+="clear \r\n",t+="cp [-r] [-v] <source> <dest> \r\n",t+="find \r\n",t+="grep <pattern> <filename> \r\n",t+="head [-n nlines] <filename> \r\n",t+="help \r\n",t+="history \r\n",t+="ls [-l] [-a] [-F] [-r] [path] \r\n",t+="mkdir <dirname> \r\n",t+="mv [-v] <source> <dest>\r\n",t+="pwd \r\n",t+="rm [-r] [-v] <path> \r\n",t+="rmdir <directory> \r\n",t+="touch <filename> \r\n",t+="tail [-n nlines] <filename> \r\n",addOutput(t)}var path="/home/guest",dirStruct=null,commandHistory=[],tmpCmd="",cIndex=-1,auth=null,awaitInput=!1,callBack=null;